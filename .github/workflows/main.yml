name: Main

on:
  push:
    branches:
      - main

jobs:
  Deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          export BACKEND_ON_PORT=${{ secrets.APP_PORT }}
          docker compose build

      - name: Save image as archive
        run: docker save test_back-backend -o tgz_backend

      - name: Checkout archive
        run: ls -lh tgz_backend

      - name: Set archive permissions
        run: chmod 644 tgz_backend

      - name: Replace archive on the VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_KEY }}
          source: tgz_backend
          target: ${{ secrets.APP_HOME }}

      - name: Deploy on the VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_KEY }}
          script: |
            docker load -i ${{ secrets.APP_HOME }}/tgz_backend
            
            export BACKEND_ON_PORT=${{ secrets.APP_PORT }}
            export TG_ADMIN_CHAT_ID=${{ secrets.ADMIN_TELEGRAM_CHAT_ID }}
            export TG_BOT_TOKEN=${{ secrets.TELEGRAM_BOT_TOKEN }}
            export DB_VOLUME_SOURCE="${{ secrets.APP_HOME }}/volume"
            export BACKEND_WORKING_DIR=/usr/app/back
            export DB_VOLUME_TARGET="${BACKEND_WORKING_DIR}/volume"
            export DB_PATH="${DB_VOLUME_TARGET}/temporarily.db"
            
            if test $(docker ps -q -f name=backend) 
              then
                docker stop backend
            fi
            
            if test $(docker ps -a -q -f name=backend)
              then
                docker rm backend
            fi
            
            if ! test $(docker images -q sln-backend)
              then
                docker compose build
            fi
            
            if test $(docker images -q sln-backend)
              then
                docker compose up -d
              else
                echo "Something went wrong"
            fi